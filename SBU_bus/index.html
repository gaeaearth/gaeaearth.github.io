<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
  <meta name="theme-color" content="#1f2937" media="(prefers-color-scheme: dark)">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <title>Stony Brook ë²„ìŠ¤ ìŠ¤ì¼€ì¤„</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class'
    }
  </script>
  <style>
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    .animate-spin {
      animation: spin 1s linear infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .animate-pulse {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    const RefreshIcon = ({ className, spinning }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
      </svg>
    );

    const ClockIcon = ({ className }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
    );

    const MapPinIcon = ({ className }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
      </svg>
    );

    const MoonIcon = ({ className }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
      </svg>
    );

    const SunIcon = ({ className }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
      </svg>
    );

    const BusIcon = ({ className }) => (
      <svg className={className} fill="currentColor" viewBox="0 0 24 24">
        <path d="M12 2C8 2 4 2.5 4 6v9.5C4 17.43 5.57 19 7.5 19L6 20.5v.5h2l2-2h4l2 2h2v-.5L16.5 19c1.93 0 3.5-1.57 3.5-3.5V6c0-3.5-4-4-8-4zm-5.5 9.5a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zm11 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zM6 15a1 1 0 0 1-1-1V8.5c0-.5.5-1 1-1h12c.5 0 1 .5 1 1V14c0 .5-.5 1-1 1H6z"/>
      </svg>
    );

    const BusSchedule = () => {
      const [schedules, setSchedules] = useState({});
      const [vehicles, setVehicles] = useState([]);
      const [loading, setLoading] = useState(true);
      const [lastUpdate, setLastUpdate] = useState(new Date());
      const [vehicleError, setVehicleError] = useState(null);
      const [showDebug, setShowDebug] = useState(false);
      const [darkMode, setDarkMode] = useState(() => {
        // ìˆ˜ë™ ì„¤ì • ì—¬ë¶€ í™•ì¸
        const manualSetting = localStorage.getItem('darkModeManual');
        if (manualSetting === 'true') {
          // ìˆ˜ë™ìœ¼ë¡œ ì„¤ì •í•œ ê²½ìš° ì €ì¥ëœ ê°’ ì‚¬ìš©
          return localStorage.getItem('darkMode') === 'true';
        }
        // ì‹œìŠ¤í…œ ì„¤ì • ë”°ë¥´ê¸°
        return window.matchMedia('(prefers-color-scheme: dark)').matches;
      });
      const [isManualMode, setIsManualMode] = useState(() => {
        return localStorage.getItem('darkModeManual') === 'true';
      });

      // Dark mode ì ìš©
      useEffect(() => {
        if (darkMode) {
          document.documentElement.classList.add('dark');
          // ì•„ì´í° ì‚¬íŒŒë¦¬ ìƒë‹¨ ë°” ìƒ‰ìƒ ë³€ê²½
          const metaThemeColor = document.querySelector('meta[name="theme-color"]');
          if (metaThemeColor) {
            metaThemeColor.setAttribute('content', '#1f2937');
          }
        } else {
          document.documentElement.classList.remove('dark');
          // ì•„ì´í° ì‚¬íŒŒë¦¬ ìƒë‹¨ ë°” ìƒ‰ìƒ ë³€ê²½
          const metaThemeColor = document.querySelector('meta[name="theme-color"]');
          if (metaThemeColor) {
            metaThemeColor.setAttribute('content', '#ffffff');
          }
        }
        
        // ìˆ˜ë™ ì„¤ì •ì¸ ê²½ìš°ë§Œ localStorageì— ì €ì¥
        if (isManualMode) {
          localStorage.setItem('darkMode', darkMode);
          localStorage.setItem('darkModeManual', 'true');
        }
      }, [darkMode, isManualMode]);

      // ì‹œìŠ¤í…œ ì„¤ì • ë³€ê²½ ê°ì§€
      useEffect(() => {
        const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
        const handleChange = (e) => {
          // ìˆ˜ë™ ëª¨ë“œê°€ ì•„ë‹ ë•Œë§Œ ì‹œìŠ¤í…œ ì„¤ì • ë”°ë¥´ê¸°
          if (!isManualMode) {
            console.log('System dark mode changed:', e.matches);
            setDarkMode(e.matches);
          }
        };
        
        mediaQuery.addEventListener('change', handleChange);
        return () => mediaQuery.removeEventListener('change', handleChange);
      }, [isManualMode]);

      const toggleDarkMode = () => {
        setDarkMode(!darkMode);
        setIsManualMode(true); // ìˆ˜ë™ìœ¼ë¡œ ë³€ê²½í•¨ì„ í‘œì‹œ
      };

      const resetToSystemMode = () => {
        const systemDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;
        setDarkMode(systemDarkMode);
        setIsManualMode(false);
        localStorage.removeItem('darkMode');
        localStorage.removeItem('darkModeManual');
      };

      const stations = [
        { 
          name: "Lot 40 Wolfie's Express West", 
          id: 37,
          url: 'https://stonybrook.etaspot.net/service.php?service=get_schedules&stopID=37&includeETAData=1&orderedETAArray=1&token=TESTING',
          color: 'red'
        },
        { 
          name: "Lot 40 Wolfie's Express East", 
          id: 36,
          url: 'https://stonybrook.etaspot.net/service.php?service=get_schedules&stopID=36&includeETAData=1&orderedETAArray=1&token=TESTING',
          color: 'blue'
        },
        { 
          name: 'Lot 40, Hosp/Chapin, Hosp Exp', 
          id: 54,
          url: 'https://stonybrook.etaspot.net/service.php?service=get_schedules&stopID=54&includeETAData=1&orderedETAArray=1&token=TESTING',
          color: 'purple'
        },
        { 
          name: 'SAC', 
          id: 1,
          url: 'https://stonybrook.etaspot.net/service.php?service=get_schedules&stopID=1&includeETAData=1&orderedETAArray=1&token=TESTING',
          color: 'purple'
        },
        { 
          name: 'Engineering', 
          id: 41,
          url: 'https://stonybrook.etaspot.net/service.php?service=get_schedules&stopID=41&includeETAData=1&orderedETAArray=1&token=TESTING',
          color: 'red'
        },
        { 
          name: 'East Side Dining', 
          id: 23,
          url: 'https://stonybrook.etaspot.net/service.php?service=get_schedules&stopID=23&includeETAData=1&orderedETAArray=1&token=TESTING',
          color: 'blue'
        }
      ];

      // ì¢…ì ìœ¼ë¡œ ì ‘ê·¼ ì¤‘ì¸ ë²„ìŠ¤ ì°¾ê¸°
      const getApproachingBuses = (stopID) => {
        if (!vehicles || vehicles.length === 0) {
          return [];
        }
        
        return vehicles.filter(v => {
          const nextStop = String(v.nextStopExtID || v.nextStopID);
          const targetStop = String(stopID);
          return nextStop === targetStop;
        });
      };

      // ì¢…ì ì—ì„œ ëŒ€ê¸°/ì¶œë°œ ì˜ˆì •ì¸ ë²„ìŠ¤ ì°¾ê¸°
      const getWaitingBuses = (stopID) => {
        if (!vehicles || vehicles.length === 0) {
          return [];
        }
        
        return vehicles.filter(v => {
          const lastStop = String(v.lastStopExtID || v.lastStopID);
          const targetStop = String(stopID);
          // ì¢…ì ì— ìˆê±°ë‚˜ ì¢…ì ì—ì„œ ë§‰ ì¶œë°œí•œ ë²„ìŠ¤
          return lastStop === targetStop && v.atStop;
        });
      };

      // ì´ˆë¥¼ ë¶„ìœ¼ë¡œ ë³€í™˜
      const secondsToMinutes = (seconds) => {
        if (!seconds || seconds < 0) return null;
        const mins = Math.ceil(seconds / 60);
        if (mins < 1) return 'ê³§';
        return `${mins}ë¶„`;
      };

      const getColorClasses = (color) => {
        const colors = {
          red: {
            icon: 'text-red-600 dark:text-red-400',
            title: 'text-red-700 dark:text-red-300',
            cardBg: 'from-red-50 to-red-100 dark:from-red-900/20 dark:to-red-800/20',
            border: 'border-red-100 hover:border-red-300 dark:border-red-800 dark:hover:border-red-600',
            timeText: 'text-red-600 dark:text-red-400',
            header: 'bg-red-50 border-red-200 dark:bg-red-900/30 dark:border-red-700',
            approaching: 'bg-orange-50 dark:bg-orange-900/20 border-orange-200 dark:border-orange-700'
          },
          blue: {
            icon: 'text-blue-600 dark:text-blue-400',
            title: 'text-blue-700 dark:text-blue-300',
            cardBg: 'from-blue-50 to-blue-100 dark:from-blue-900/20 dark:to-blue-800/20',
            border: 'border-blue-100 hover:border-blue-300 dark:border-blue-800 dark:hover:border-blue-600',
            timeText: 'text-blue-600 dark:text-blue-400',
            header: 'bg-blue-50 border-blue-200 dark:bg-blue-900/30 dark:border-blue-700',
            approaching: 'bg-orange-50 dark:bg-orange-900/20 border-orange-200 dark:border-orange-700'
          },
          purple: {
            icon: 'text-purple-600 dark:text-purple-400',
            title: 'text-purple-700 dark:text-purple-300',
            cardBg: 'from-purple-50 to-purple-100 dark:from-purple-900/20 dark:to-purple-800/20',
            border: 'border-purple-100 hover:border-purple-300 dark:border-purple-800 dark:hover:border-purple-600',
            timeText: 'text-purple-600 dark:text-purple-400',
            header: 'bg-purple-50 border-purple-200 dark:bg-purple-900/30 dark:border-purple-700',
            approaching: 'bg-orange-50 dark:bg-orange-900/20 border-orange-200 dark:border-orange-700'
          }
        };
        return colors[color] || colors.red;
      };

      const parseTime = (timeStr) => {
        const match = timeStr.match(/(\d+):(\d+)(AM|PM)/);
        if (!match) return null;
        
        const [, hours, minutes, period] = match;
        let hour24 = parseInt(hours);
        
        if (period === 'PM' && hour24 !== 12) {
          hour24 += 12;
        } else if (period === 'AM' && hour24 === 12) {
          hour24 = 0;
        }
        
        const today = new Date();
        return new Date(today.getFullYear(), today.getMonth(), today.getDate(), hour24, parseInt(minutes));
      };

      const getUpcomingBuses = (busData) => {
        const now = new Date();
        
        if (!busData || !busData.get_schedules) {
          return [];
        }

        const upcoming = busData.get_schedules
          .map(bus => ({
            ...bus,
            parsedTime: parseTime(bus.stopTime)
          }))
          .filter(bus => bus.parsedTime && bus.parsedTime > now)
          .sort((a, b) => a.parsedTime - b.parsedTime)
          .slice(0, 4);

        return upcoming;
      };

      const getMinutesUntil = (timeStr) => {
        const busTime = parseTime(timeStr);
        if (!busTime) return 'ì •ë³´ ì—†ìŒ';
        
        const now = new Date();
        const diff = Math.floor((busTime - now) / 60000);
        
        if (diff < 1) return 'ê³§ ì¶œë°œ';
        if (diff < 60) return `${diff}ë¶„`;
        
        const hours = Math.floor(diff / 60);
        const mins = diff % 60;
        return `${hours}ì‹œê°„ ${mins}ë¶„`;
      };

      const fetchVehicles = async () => {
        try {
          console.log('Fetching vehicle data...');
          const response = await fetch('https://stonybrook.etaspot.net/service.php?service=get_vehicles&includeETAData=1&inService=1&orderedETAArray=1&token=TESTING');
          
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          
          const data = await response.json();
          console.log('Vehicle API Response:', data);
          
          const vehicleList = data.get_vehicles || [];
          console.log('Number of vehicles:', vehicleList.length);
          
          // ê° ë²„ìŠ¤ì˜ ì •ë³´ ìš”ì•½
          if (vehicleList.length > 0) {
            console.log('Vehicle summary:');
            vehicleList.forEach((v, i) => {
              console.log(`  [${i}] Bus #${v.equipmentID}: nextStopExtID=${v.nextStopExtID}, lastStopExtID=${v.lastStopExtID}, atStop=${v.atStop}, ETA=${v.nextStopETA}s`);
            });
          }
          
          setVehicles(vehicleList);
          setVehicleError(null);
          return vehicleList;
        } catch (error) {
          console.error('Error fetching vehicles:', error);
          setVehicleError(error.message);
          setVehicles([]);
          return [];
        }
      };

      const getVehicleInfo = (runID, stopID) => {
        if (!vehicles || vehicles.length === 0) {
          return null;
        }
        
        // ì—¬ëŸ¬ ì¡°ê±´ìœ¼ë¡œ ë§¤ì¹­ ì‹œë„
        let vehicle = vehicles.find(v => v.runID === runID);
        
        if (!vehicle) {
          // runIDê°€ ë¬¸ìì—´/ìˆ«ì íƒ€ì… ì°¨ì´ë¡œ ë§¤ì¹­ ì•ˆë  ìˆ˜ ìˆìœ¼ë¯€ë¡œ
          vehicle = vehicles.find(v => String(v.runID) === String(runID));
        }
        
        if (!vehicle) {
          // nextStopIDë¡œë„ ì‹œë„
          vehicle = vehicles.find(v => 
            (v.nextStopID === stopID || String(v.nextStopID) === String(stopID))
          );
        }
        
        return vehicle;
      };

      const isVehicleActive = (runID) => {
        if (!vehicles || vehicles.length === 0) {
          return false;
        }
        return vehicles.some(v => 
          v.runID === runID || String(v.runID) === String(runID)
        );
      };

      const fetchSchedules = async () => {
        setLoading(true);
        const newSchedules = {};

        try {
          // ìŠ¤ì¼€ì¤„ê³¼ ì‹¤ì‹œê°„ ìœ„ì¹˜ ì •ë³´ ë™ì‹œì— ê°€ì ¸ì˜¤ê¸°
          const [scheduleResults, vehicleResult] = await Promise.all([
            Promise.all(
              stations.map(async (station) => {
                try {
                  const response = await fetch(station.url);
                  const data = await response.json();
                  return { id: station.id, data };
                } catch (error) {
                  console.error(`Error fetching ${station.name}:`, error);
                  return { id: station.id, data: null };
                }
              })
            ),
            fetchVehicles()
          ]);

          // ìŠ¤ì¼€ì¤„ ë°ì´í„° ì €ì¥
          scheduleResults.forEach(result => {
            newSchedules[result.id] = result.data;
          });

          setSchedules(newSchedules);
          setLastUpdate(new Date());
        } catch (error) {
          console.error('Error fetching schedules:', error);
        } finally {
          setLoading(false);
        }
      };

      useEffect(() => {
        fetchSchedules();
        const interval = setInterval(fetchSchedules, 15000); // 15ì´ˆë§ˆë‹¤ ì—…ë°ì´íŠ¸
        return () => clearInterval(interval);
      }, []);

      return (
        <div className="min-h-screen bg-gradient-to-br from-gray-50 to-slate-100 dark:from-gray-900 dark:to-slate-900 p-6 transition-colors">
          <div className="max-w-7xl mx-auto">
            {/* Header */}
            <div className="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 mb-6 transition-colors">
              <div className="flex items-center justify-between flex-wrap gap-4">
                <div>
                  <h1 className="text-3xl font-bold text-gray-800 dark:text-gray-100 mb-2">
                    Stony Brook ë²„ìŠ¤ ìŠ¤ì¼€ì¤„
                  </h1>
                  <div className="flex items-center text-gray-600 dark:text-gray-400 text-sm">
                    <ClockIcon className="w-4 h-4 mr-2" />
                    ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: {lastUpdate.toLocaleTimeString('ko-KR')}
                  </div>
                </div>
                <div className="flex items-center gap-2">
                  <button
                    onClick={() => setShowDebug(!showDebug)}
                    className="flex items-center gap-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 px-4 py-2 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors text-sm"
                    title="ë””ë²„ê·¸ ì •ë³´ í‘œì‹œ/ìˆ¨ê¹€"
                  >
                    ğŸ” ë””ë²„ê·¸
                  </button>
                  <button
                    onClick={toggleDarkMode}
                    className="flex items-center gap-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 px-4 py-2 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors"
                    title={darkMode ? "ë¼ì´íŠ¸ ëª¨ë“œë¡œ ì „í™˜" : "ë‹¤í¬ ëª¨ë“œë¡œ ì „í™˜"}
                  >
                    {darkMode ? <SunIcon className="w-5 h-5" /> : <MoonIcon className="w-5 h-5" />}
                    {isManualMode && <span className="text-xs">ğŸ”’</span>}
                  </button>
                  {isManualMode && (
                    <button
                      onClick={resetToSystemMode}
                      className="flex items-center gap-2 bg-blue-200 dark:bg-blue-700 text-blue-800 dark:text-blue-200 px-3 py-2 rounded-lg hover:bg-blue-300 dark:hover:bg-blue-600 transition-colors text-sm"
                      title="ì‹œìŠ¤í…œ ì„¤ì • ë”°ë¥´ê¸°"
                    >
                      âš™ï¸
                    </button>
                  )}
                  <button
                    onClick={fetchSchedules}
                    disabled={loading}
                    className="flex items-center gap-2 bg-slate-600 dark:bg-slate-700 text-white px-4 py-2 rounded-lg hover:bg-slate-700 dark:hover:bg-slate-600 disabled:bg-gray-400 dark:disabled:bg-gray-600 transition-colors"
                  >
                    <RefreshIcon className={`w-5 h-5 ${loading ? 'animate-spin' : ''}`} spinning={loading} />
                    ìƒˆë¡œê³ ì¹¨
                  </button>
                </div>
              </div>
            </div>

            {/* Debug Panel */}
            {showDebug && (
              <div className="bg-yellow-50 dark:bg-yellow-900/20 border-2 border-yellow-400 dark:border-yellow-600 rounded-lg p-6 mb-6">
                <h3 className="text-lg font-bold text-yellow-800 dark:text-yellow-300 mb-4">ğŸ” ë””ë²„ê·¸ ì •ë³´</h3>
                
                <div className="space-y-4">
                  <div>
                    <h4 className="font-semibold text-yellow-700 dark:text-yellow-400 mb-2">ì‹¤ì‹œê°„ ë²„ìŠ¤ ì •ë³´:</h4>
                    <div className="bg-white dark:bg-gray-800 p-3 rounded border border-yellow-300 dark:border-yellow-700">
                      <p className="text-sm text-gray-700 dark:text-gray-300">
                        <strong>ìš´í–‰ì¤‘ì¸ ë²„ìŠ¤ ìˆ˜:</strong> {vehicles.length}
                      </p>
                      {vehicleError && (
                        <p className="text-sm text-red-600 dark:text-red-400 mt-2">
                          <strong>ì—ëŸ¬:</strong> {vehicleError}
                        </p>
                      )}
                      {vehicles.length > 0 && (
                        <div className="mt-2">
                          <p className="text-sm text-gray-700 dark:text-gray-300 mb-2">
                            <strong>ê° ì¢…ì ë³„ ìƒíƒœ:</strong>
                          </p>
                          {stations.map(station => {
                            const approaching = getApproachingBuses(station.id);
                            const waiting = getWaitingBuses(station.id);
                            return (
                              <div key={station.id} className="text-xs text-gray-600 dark:text-gray-400 ml-2 mb-1">
                                â€¢ {station.name}: ì ‘ê·¼ì¤‘ {approaching.length}ëŒ€, ëŒ€ê¸°ì¤‘ {waiting.length}ëŒ€
                              </div>
                            );
                          })}
                        </div>
                      )}
                      {vehicles.length > 0 && (
                        <div className="mt-2 max-h-60 overflow-y-auto">
                          <pre className="text-xs text-gray-600 dark:text-gray-400 whitespace-pre-wrap">
                            {JSON.stringify(vehicles.slice(0, 3), null, 2)}
                          </pre>
                          {vehicles.length > 3 && (
                            <p className="text-xs text-gray-500 dark:text-gray-500 mt-2">
                              ... ê·¸ ì™¸ {vehicles.length - 3}ê°œ ë²„ìŠ¤
                            </p>
                          )}
                        </div>
                      )}
                    </div>
                  </div>

                  <div>
                    <h4 className="font-semibold text-yellow-700 dark:text-yellow-400 mb-2">API ì •ë³´:</h4>
                    <div className="bg-white dark:bg-gray-800 p-3 rounded border border-yellow-300 dark:border-yellow-700 text-xs">
                      <p className="text-gray-700 dark:text-gray-300">
                        <strong>Vehicle API:</strong><br/>
                        <code className="bg-gray-100 dark:bg-gray-700 px-1 py-0.5 rounded">
                          https://stonybrook.etaspot.net/service.php?service=get_vehicles...
                        </code>
                      </p>
                      <p className="text-gray-700 dark:text-gray-300 mt-2">
                        <strong>ë§¤ì¹­ ë°©ì‹:</strong> nextStopExtID = ì¢…ì ID (ì ‘ê·¼ì¤‘), lastStopExtID = ì¢…ì ID (ëŒ€ê¸°ì¤‘)
                      </p>
                    </div>
                  </div>

                  <div>
                    <h4 className="font-semibold text-yellow-700 dark:text-yellow-400 mb-2">ë‹¤í¬ëª¨ë“œ ìƒíƒœ:</h4>
                    <div className="bg-white dark:bg-gray-800 p-3 rounded border border-yellow-300 dark:border-yellow-700 text-xs">
                      <p className="text-gray-700 dark:text-gray-300">
                        <strong>í˜„ì¬ ëª¨ë“œ:</strong> {darkMode ? 'ë‹¤í¬ëª¨ë“œ' : 'ë¼ì´íŠ¸ëª¨ë“œ'}
                      </p>
                      <p className="text-gray-700 dark:text-gray-300 mt-1">
                        <strong>ì„¤ì • ë°©ì‹:</strong> {isManualMode ? 'ìˆ˜ë™ ì„¤ì • ğŸ”’' : 'ì‹œìŠ¤í…œ ì„¤ì • ë”°ë¥´ê¸° âš™ï¸'}
                      </p>
                      <p className="text-gray-700 dark:text-gray-300 mt-1">
                        <strong>ì‹œìŠ¤í…œ ì„¤ì •:</strong> {window.matchMedia('(prefers-color-scheme: dark)').matches ? 'ë‹¤í¬ëª¨ë“œ' : 'ë¼ì´íŠ¸ëª¨ë“œ'}
                      </p>
                    </div>
                  </div>

                  <button
                    onClick={() => {
                      console.clear();
                      fetchVehicles().then(() => {
                        console.log('Manual fetch completed. Check console for details.');
                      });
                    }}
                    className="bg-yellow-500 dark:bg-yellow-600 text-white px-4 py-2 rounded-lg hover:bg-yellow-600 dark:hover:bg-yellow-700 text-sm font-semibold"
                  >
                    ğŸ”„ ë²„ìŠ¤ ìœ„ì¹˜ ë‹¤ì‹œ ê°€ì ¸ì˜¤ê¸°
                  </button>
                </div>
              </div>
            )}

            {/* Schedules Grid */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              {stations.map((station) => {
                const upcomingBuses = getUpcomingBuses(schedules[station.id]);
                const approachingBuses = getApproachingBuses(station.id);
                const waitingBuses = getWaitingBuses(station.id);
                const colorClasses = getColorClasses(station.color);

                return (
                  <div key={station.id} className="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 transition-colors">
                    <div className={`flex items-start mb-4 p-3 rounded-lg border ${colorClasses.header}`}>
                      <MapPinIcon className={`w-6 h-6 ${colorClasses.icon} mr-2 mt-1 flex-shrink-0`} />
                      <h2 className={`text-xl font-bold ${colorClasses.title}`}>{station.name}</h2>
                    </div>

                    {/* ì ‘ê·¼ ì¤‘ì¸ ë²„ìŠ¤ */}
                    {approachingBuses.length > 0 && (
                      <div className="mb-4">
                        <h3 className="text-sm font-semibold text-orange-700 dark:text-orange-400 mb-2 flex items-center gap-2">
                          <BusIcon className="w-4 h-4" />
                          ğŸš ì¢…ì ìœ¼ë¡œ ì ‘ê·¼ ì¤‘
                        </h3>
                        <div className="space-y-2">
                          {approachingBuses.map((bus, index) => {
                            const eta = secondsToMinutes(bus.nextStopETA);
                            return (
                              <div
                                key={`approaching-${bus.equipmentID}-${index}`}
                                className={`p-3 rounded-lg border-2 ${colorClasses.approaching} border-orange-300 dark:border-orange-600`}
                              >
                                <div className="flex justify-between items-center">
                                  <div>
                                    <div className="font-semibold text-orange-800 dark:text-orange-300">
                                      ë²„ìŠ¤ #{bus.equipmentID}
                                    </div>
                                    <div className="text-xs text-orange-600 dark:text-orange-400 mt-1">
                                      {bus.direction} â€¢ ë…¸ì„  {bus.routeID}
                                    </div>
                                    {bus.load !== undefined && bus.capacity && (
                                      <div className="text-xs text-gray-600 dark:text-gray-400 mt-1">
                                        íƒ‘ìŠ¹: {bus.load}/{bus.capacity}ëª…
                                      </div>
                                    )}
                                  </div>
                                  <div className="text-right">
                                    <div className="text-2xl font-bold text-orange-600 dark:text-orange-400">
                                      {eta || 'ê³§'}
                                    </div>
                                    <div className="text-xs text-orange-600 dark:text-orange-400">
                                      í›„ ë„ì°©
                                    </div>
                                  </div>
                                </div>
                              </div>
                            );
                          })}
                        </div>
                      </div>
                    )}

                    {/* ëŒ€ê¸° ì¤‘ì¸ ë²„ìŠ¤ */}
                    {waitingBuses.length > 0 && (
                      <div className="mb-4">
                        <h3 className="text-sm font-semibold text-green-700 dark:text-green-400 mb-2 flex items-center gap-2">
                          <BusIcon className="w-4 h-4" />
                          â¸ï¸ ì¢…ì  ëŒ€ê¸° ì¤‘
                        </h3>
                        <div className="space-y-2">
                          {waitingBuses.map((bus, index) => (
                            <div
                              key={`waiting-${bus.equipmentID}-${index}`}
                              className="p-3 bg-green-50 dark:bg-green-900/20 rounded-lg border border-green-200 dark:border-green-700"
                            >
                              <div className="flex justify-between items-center">
                                <div>
                                  <div className="font-semibold text-green-800 dark:text-green-300">
                                    ë²„ìŠ¤ #{bus.equipmentID}
                                  </div>
                                  <div className="text-xs text-green-600 dark:text-green-400">
                                    {bus.direction} â€¢ ë…¸ì„  {bus.routeID}
                                  </div>
                                </div>
                                <div className="text-sm font-semibold text-green-600 dark:text-green-400">
                                  ëŒ€ê¸°ì¤‘
                                </div>
                              </div>
                            </div>
                          ))}
                        </div>
                      </div>
                    )}

                    {/* ì¶œë°œ ìŠ¤ì¼€ì¤„ */}
                    <h3 className="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                      ğŸ“… ì¶œë°œ ìŠ¤ì¼€ì¤„
                    </h3>

                    {loading ? (
                      <div className="text-center py-8 text-gray-500 dark:text-gray-400">
                        ë¡œë”© ì¤‘...
                      </div>
                    ) : upcomingBuses.length === 0 ? (
                      <div className="text-center py-8 text-gray-500 dark:text-gray-400">
                        ë‹¤ê°€ì˜¤ëŠ” ë²„ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤
                      </div>
                    ) : (
                      <div className="space-y-3">
                        {upcomingBuses.map((bus, index) => {
                          const vehicleInfo = getVehicleInfo(bus.runID, station.id);
                          const isActive = isVehicleActive(bus.runID);
                          const hasRealTimeETA = vehicleInfo && vehicleInfo.eta;
                          
                          return (
                            <div
                              key={`${bus.runID}-${bus.stopTime}-${index}`}
                              className={`flex items-center justify-between p-4 bg-gradient-to-r ${colorClasses.cardBg} rounded-lg border ${colorClasses.border} transition-colors ${isActive ? 'ring-2 ring-green-400 dark:ring-green-500' : ''}`}
                            >
                              <div className="flex-1">
                                <div className="flex items-center gap-2">
                                  <div className="font-bold text-lg text-gray-800 dark:text-gray-200">
                                    {bus.stopTime}
                                  </div>
                                  {isActive && (
                                    <div className="flex items-center gap-1 px-2 py-1 bg-green-100 dark:bg-green-900/40 rounded-full">
                                      <BusIcon className="w-4 h-4 text-green-600 dark:text-green-400 animate-pulse" />
                                      <span className="text-xs font-semibold text-green-700 dark:text-green-300">ìš´í–‰ì¤‘</span>
                                    </div>
                                  )}
                                  {showDebug && (
                                    <span className="text-xs bg-gray-200 dark:bg-gray-700 px-2 py-1 rounded text-gray-600 dark:text-gray-400">
                                      ID:{bus.runID}
                                    </span>
                                  )}
                                </div>
                                <div className="text-sm text-gray-600 dark:text-gray-400 mt-1">
                                  {bus.scheduleName}
                                </div>
                                <div className="text-xs text-gray-500 dark:text-gray-500 mt-1">
                                  {bus.directionLabel} â€¢ Track {bus.track}
                                </div>
                                {hasRealTimeETA && vehicleInfo.nextStopName && (
                                  <div className="text-xs text-green-600 dark:text-green-400 mt-1 font-medium">
                                    ë‹¤ìŒ ì •ë¥˜ì¥: {vehicleInfo.nextStopName}
                                  </div>
                                )}
                                {showDebug && vehicleInfo && (
                                  <div className="text-xs text-purple-600 dark:text-purple-400 mt-1">
                                    Vehicle found: {JSON.stringify(vehicleInfo, null, 2).substring(0, 100)}...
                                  </div>
                                )}
                              </div>
                              <div className="text-right">
                                <div className={`text-2xl font-bold ${colorClasses.timeText}`}>
                                  {hasRealTimeETA ? `${vehicleInfo.eta}ë¶„` : getMinutesUntil(bus.stopTime)}
                                </div>
                                <div className="text-xs text-gray-500 dark:text-gray-500 mt-1">
                                  {hasRealTimeETA ? 'ì‹¤ì‹œê°„' : 'í›„ ì¶œë°œ'}
                                </div>
                              </div>
                            </div>
                          );
                        })}
                      </div>
                    )}
                  </div>
                );
              })}
            </div>

            {/* Footer */}
            <div className="text-center text-gray-500 dark:text-gray-400 text-sm mt-8 space-y-2">
              <div>ìë™ìœ¼ë¡œ 15ì´ˆë§ˆë‹¤ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤</div>
              <div className="flex flex-wrap items-center justify-center gap-4">
                <div className="flex items-center gap-2">
                  <span className="text-orange-600 dark:text-orange-400">ğŸš</span>
                  <span className="text-orange-600 dark:text-orange-400">ì¢…ì ìœ¼ë¡œ ì ‘ê·¼ ì¤‘ì¸ ë²„ìŠ¤</span>
                </div>
                <div className="flex items-center gap-2">
                  <span className="text-green-600 dark:text-green-400">â¸ï¸</span>
                  <span className="text-green-600 dark:text-green-400">ì¢…ì ì—ì„œ ëŒ€ê¸° ì¤‘ì¸ ë²„ìŠ¤</span>
                </div>
                <div className="flex items-center gap-2">
                  <BusIcon className="w-4 h-4 text-green-600 dark:text-green-400" />
                  <span className="text-green-600 dark:text-green-400">ìš´í–‰ì¤‘ì¸ ë²„ìŠ¤</span>
                </div>
              </div>
              {isManualMode && (
                <div className="text-xs text-blue-600 dark:text-blue-400 mt-2">
                  ğŸ”’ ìˆ˜ë™ ëª¨ë“œ í™œì„±í™”ë¨ â€¢ âš™ï¸ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹œìŠ¤í…œ ì„¤ì • ë”°ë¥´ê¸°
                </div>
              )}
              {!isManualMode && (
                <div className="text-xs text-gray-400 dark:text-gray-500 mt-2">
                  âš™ï¸ ì‹œìŠ¤í…œ ì„¤ì •ì— ë”°ë¼ ìë™ìœ¼ë¡œ ë‹¤í¬ëª¨ë“œ ì „í™˜
                </div>
              )}
            </div>
          </div>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<BusSchedule />);
  </script>
</body>
</html>
